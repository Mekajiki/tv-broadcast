#!/usr/bin/env ruby
require 'uri'
require 'open3'
require 'nkf'

include System

unless ARGV.length == 1
  print "usage: #{$0} FILE \n"
  abort
end

md5_str = Digest::MD5.file(ARGV[0]).hexdigest
program_title = File.basename(ARGV[0], '.ts')
source_file_name = md5_str + ".ts"
work_dir = Settings.movie.workspace + Digest::MD5.hexdigest(File.basename(ARGV[0], '.ts'))
Dir.mkdir work_dir
begin
  System.exec "mv '#{ARGV[0]}' #{work_dir}/#{source_file_name}"

  stdin, stdout, stderr = Open3.popen3 "epgdump json #{work_dir}/#{source_file_name} -"
  epg = JSON.parse(stdout.read)
  program_info = epg[0]['programs'].find do |info|
    NKF.nkf('-m0Z1 -w', ARGV[0]).index NKF.nkf('-m0Z1 -w', info['title'].split('【')[0])
  end
  p program_info
  raise unless program_info

  program = Program.new_from_epg(program_info)

  @ffmpeg_option = '-tune animation' if program.is_anime?

  dist_path = "#{Settings.movie.storage}/#{md5_str}.mp4"
  Movie::Encoder.encode(
    "#{work_dir}/#{source_file_name}",
    "#{dist_path}",
    "#{@ffmpeg_option}"
  )

  program.movie_file_name = md5_str + '.mp4'
  raise unless program.save
rescue Exception => ex
  puts ex.message
  puts ex.backtrace.join("\n")

  STDERR.puts "registration failed: #{ARGV[0]}"
  escape_path = "#{Settings.movie.failed_ts_path}/#{program_title}.ts"
  STDERR.puts "save to #{escape_path}"
  System.exec "mv #{work_dir}/#{source_file_name} #{escape_path}"
ensure
  System.exec "rm -rf #{work_dir}"
end
